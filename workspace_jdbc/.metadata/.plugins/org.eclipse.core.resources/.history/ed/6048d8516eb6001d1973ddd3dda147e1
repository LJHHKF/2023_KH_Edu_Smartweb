package main;

import java.util.ArrayList;
import java.util.Scanner;

import dao.StudentDAO;
import dto.StudentDTO;

public class Main {
	public static void main(String[] args) {
		Scanner sc = new Scanner(System.in);
		final String url = "jdbc:oracle:thin:@localhost:1521:xe";
		final String dbID = "kh";
		final String dbPW = "kh";
		Main self = new Main();
		StudentDAO dao = null;
		try {
			dao = new StudentDAO(url, dbID, dbPW);
		}catch(Exception e) {
			System.out.println("DAO 생성 실패");
			e.printStackTrace();
			System.exit(0);
		}
		
		try {
			while(true) {
				int menu = 0;
				while(true) {
					try {
						System.out.println("<< 학생정보 관리 프로그램 >>");
						System.out.println("1. 학생정보 입력");
						System.out.println("2. 학생목록 출력");
						System.out.println("3. 학생정보 수정"); // --학번
						System.out.println("4. 학생정보 삭제"); // --학번
						System.out.println("5. 학생정보 검색"); // --이름
						System.out.println("0. 시스템 종료");
						System.out.print(">> ");
						menu = Integer.parseInt(sc.nextLine());
						break;
					}catch(Exception e) {
						System.out.println("메뉴 번호는 숫자 형식으로 입력해주셔야 합니다.");
						e.printStackTrace();
					}
				}
				if(menu == 0) {
					dao.closes();
					System.out.println("프로그램을 종료합니다.");
					System.exit(0);
				}else if(menu == 1) {
					String name = self.inputText(sc, "신규 등록할 학생 이름 : ");
					int kor = self.inputNumber(sc, name + " 학생의 국어 점수 : ");
					int eng = self.inputNumber(sc, name + " 학생의 영어 점수 : ");
					int math = self.inputNumber(sc, name + " 학생의 수학 점수 : ");
					StudentDTO dto = new StudentDTO(0, name, kor, eng, math);
					if(dao.insert(dto) > 0) {
						System.out.println("입력 성공");
					}else {
						System.out.println("입력 실패");
					}
				}else if(menu == 2) {
					self.printStudents(dao.selectAll());
				}else if(menu == 3) {
					int id = self.inputNumber(sc, "수정할 학생의 학번 : ");
					if(!dao.isIdExist(id)) {
						System.out.println("해당 학번의 학생이 없습니다.");
						continue;
					}
					String name = self.inputText(sc, "수정할 학생 이름 : ");
					int kor = self.inputNumber(sc, name + " 학생의 국어 점수 : ");
					int eng = self.inputNumber(sc, name + " 학생의 영어 점수 : ");
					int math = self.inputNumber(sc, name + " 학생의 수학 점수 : ");
					StudentDTO dto = new StudentDTO(id, name, kor, eng, math);
					if(dao.updateByID(dto) > 0) {
						System.out.println("수정 성공");
					}else {
						System.out.println("수정 실패");
					}
				}else if(menu == 4) {
					int id = self.inputNumber(sc, "삭제할 학생의 학번 : ");
					if(!dao.isIdExist(id)) {
						System.out.println("해당 학번의 학생이 없습니다.");
						continue;
					}
					if(dao.deleteByID(id) > 0) {
						System.out.println("삭제 성공");
					}else {
						System.out.println("삭제 실패");
					}
				}else if(menu == 5) {
					String name = self.inputText(sc, "검색 할 학생 이름 키워드 : ");
					ArrayList<StudentDTO> result = dao.searchByName(name);
					if(result.isEmpty()) {
						System.out.println("찾은 정보가 없습니다.");
					}else {
						self.printStudents(result);
					}
				}else {
					System.out.println("없는 메뉴 번호입니다.");
				}
			}
		}catch(Exception e) {
			try {
				dao.closes();
			}catch(Exception e2) {
				System.out.println("오류 후 close 실패");
			}
			e.printStackTrace();
		}
	}
	
	private int inputNumber(Scanner sc, String infoText) {
		int result = 0;
		while(true) {
			try {
				System.out.print(infoText);
				result = Integer.parseInt(sc.nextLine());
				break;
			}catch(Exception e) {
				System.out.println("숫자 형식으로 입력해 주셔야 합니다");
				e.printStackTrace();
			}
		}
		return result;
	}
	
	private String inputText(Scanner sc, String infoText) {
		System.out.print(infoText);
		return sc.nextLine();
	}
	
	private void printStudents(ArrayList<StudentDTO> list) {
		if(list.isEmpty()) {
			System.out.println("출력할 정보가 없습니다.");
		}else {
			System.out.println("학번\t이름\t국어\t영어\t수학\t평균");
			for(StudentDTO dto : list) {
				System.out.println(dto.getId() + "\t" +
									dto.getName() + "\t" +
									dto.getKor() + "\t" +
									dto.getEng() + "\t" +
									dto.getMath() + "\t"+
									dto.getAvarage());
			}
		}
		
	}
}
